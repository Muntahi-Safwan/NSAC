// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model User {
  id              String            @id @default(uuid())
  email           String            @unique
  password        String
  firstName       String?
  lastName        String?
  phoneNumbers    String[]          @default([])
  primaryPhone    String?           // Primary phone for SMS alerts
  socialUsernames Json?
  age             Int?              // User's age
  diseases        String[]          @default([]) // User's diseases (multi-select)
  allergies       String[]          @default([]) // User's allergies (multi-select)
  lastLocation    Json?             // {city, region, country, lat, lng}
  isSafe          Boolean           @default(true)
  safetyUpdatedAt DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  notifications   Notification[]
  quizAttempts    QuizAttempt[]

  @@map("users")
}

model NGO {
  id              String         @id @default(uuid())
  email           String         @unique
  password        String
  name            String
  description     String?
  website         String?        // NGO website
  address         String?        // Physical address
  region          String         // City/Region they operate in
  country         String         @default("Bangladesh")
  coordinates     Json?          // {lat, lng}
  contactPhone    String?
  emergencyPhone  String?        // Emergency contact number
  operatingHours  String?        // Operating hours
  verified        Boolean        @default(false)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  notifications   Notification[]

  @@map("ngos")
}

model Notification {
  id          String    @id @default(uuid())
  ngoId       String
  ngo         NGO       @relation(fields: [ngoId], references: [id], onDelete: Cascade)

  title       String
  message     String
  severity    String    // info, warning, danger, critical
  region      String    // Target region
  isAlert     Boolean   @default(false) // Is this a disaster alert?

  createdAt   DateTime  @default(now())
  expiresAt   DateTime?

  recipients  User[]

  @@index([ngoId])
  @@index([region])
  @@index([createdAt])
  @@map("notifications")
}

model Quiz {
  id          String        @id @default(uuid())
  title       String
  description String?
  difficulty  String        // beginner, intermediate, advanced
  category    String        // air_quality, health, environment
  questions   Json          // Array of question objects
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  attempts    QuizAttempt[]

  @@map("quizzes")
}

model QuizAttempt {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  quizId      String
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)

  score       Int
  totalQuestions Int
  answers     Json     // Array of user answers with correctness
  difficulty  String

  completedAt DateTime @default(now())

  @@index([userId])
  @@index([quizId])
  @@map("quiz_attempts")
}

model AirQualityForecast {
  id               Int      @id @default(autoincrement())
  timestamp        DateTime // Forecast valid time
  forecastInitTime DateTime // When the forecast was initialized (00z or 12z)
  
  // Location (filtered to TEMPO coverage: North America)
  latitude         Float    // Range: ~15°N to ~60°N
  longitude        Float    // Range: ~-130°W to ~-60°W
  level            Float    // Atmospheric level (surface = 0)
  
  // Pollutant concentrations (μg/m³ unless noted)
  // All available from GEOS-CF
  pm25             Float?   // PM2.5 - Particulate Matter < 2.5μm
  no2              Float?   // NO2 - Nitrogen Dioxide
  o3               Float?   // O3 - Ozone
  so2              Float?   // SO2 - Sulfur Dioxide  
  co               Float?   // CO - Carbon Monoxide (ppbv)
  hcho             Float?   // HCHO - Formaldehyde
  
  // Calculated AQI
  aqi              Float?   // Overall Air Quality Index (0-500)
  
  // Metadata
  source           String   @default("GEOS-CF-FORECAST")
  createdAt        DateTime @default(now())
  
  // Composite indexes for efficient geospatial + time queries
  // PostGIS will use these for nearest-neighbor searches
  @@index([latitude, longitude])
  @@index([timestamp])
  @@index([forecastInitTime])
  @@index([timestamp, latitude, longitude])
  @@index([source])
  @@map("air_quality_forecasts")
}

model AirQualityRealtime {
  id               Int      @id @default(autoincrement())
  timestamp        DateTime // Observation time (when measurement was taken)
  
  // Location (North America coverage)
  latitude         Float    // Range: ~15°N to ~60°N
  longitude        Float    // Range: ~-130°W to ~-60°W
  level            Float    @default(0) // Atmospheric level (surface = 0)
  
  // Real-time pollutants (μg/m³ unless noted)
  // GEOS-CF analysis data + AirNOW ground data
  pm25             Float?   // PM2.5 - Particulate Matter (GEOS-CF analysis)
  no2              Float?   // NO2 - Nitrogen Dioxide (GEOS-CF analysis)
  o3               Float?   // O3 - Ozone (GEOS-CF analysis)
  so2              Float?   // SO2 - Sulfur Dioxide (GEOS-CF analysis)
  co               Float?   // CO - Carbon Monoxide (GEOS-CF analysis)
  hcho             Float?   // HCHO - Formaldehyde (GEOS-CF analysis)
  
  // Calculated AQI (same method as forecast)
  aqi              Float?   // Overall Air Quality Index (0-500)
  
  // Metadata
  source           String   @default("GEOS-CF-ANALYSIS")
  createdAt        DateTime @default(now())
  
  // Unique constraint to prevent duplicate data
  @@unique([timestamp, latitude, longitude, source])
  
  // Composite indexes for efficient geospatial + time queries
  @@index([latitude, longitude])
  @@index([timestamp])
  @@index([timestamp, latitude, longitude])
  @@index([source])
  @@map("air_quality_realtime")
}

// Meteorological Data - Raw weather data from NASA GEOS-CF
model MeteorologicalData {
  id                    Int      @id @default(autoincrement())
  
  // Location
  latitude              Float    // Geographic latitude
  longitude             Float    // Geographic longitude
  
  // Temporal information (hourly resolution)
  forecastHour          DateTime // Specific hour this forecast is for
  forecastInitTime      DateTime // When forecast was generated
  createdAt             DateTime @default(now())
  
  // Raw meteorological parameters
  temperature           Float    // Temperature (°C)
  humidity              Float    // Relative humidity (%)
  windSpeed             Float    // Wind speed (m/s)
  pressure              Float    // Surface pressure (Pa)
  
  // Metadata
  source                String   @default("GEOS-CF")
  
  // Unique constraint - one record per location per hour
  @@unique([latitude, longitude, forecastHour, forecastInitTime])
  
  // Indexes for efficient queries
  @@index([forecastHour])
  @@index([latitude, longitude])
  @@index([forecastHour, latitude, longitude]) // Spatial-temporal queries
  
  @@map("meteorological_data")
}

// Heatwave Alerts - Simple daily heatwave alerts
model HeatwaveAlerts {
  id                    Int      @id @default(autoincrement())
  
  // Location
  latitude              Float    // Geographic latitude
  longitude             Float    // Geographic longitude
  
  // Temporal information
  alertDate             DateTime @db.Date // Date this alert is for
  forecastInitTime      DateTime // When forecast was generated
  createdAt             DateTime @default(now())
  
  // Simple heatwave indicators
  maxTemperature        Float    // Daily maximum temperature (°C)
  minTemperature        Float    // Daily minimum temperature (°C)
  maxHeatIndex          Float    // Maximum heat index (°C)
  
  // Alert level
  alertLevel            Int      // 0=None, 1=Watch, 2=Warning, 3=Emergency
  alertMessage          String?  // Human-readable alert message
  
  // Metadata
  source                String   @default("GEOS-CF")
  
  // Unique constraint to prevent duplicate alerts
  @@unique([latitude, longitude, alertDate, forecastInitTime])
  
  // Indexes for efficient queries
  @@index([latitude, longitude])
  @@index([alertDate])
  @@index([alertLevel]) // For filtering alerts by severity
  
  @@map("heatwave_alerts")
}

model FireDetections {
  id                    Int      @id @default(autoincrement())
  
  // Location
  latitude              Float    // Geographic latitude
  longitude             Float    // Geographic longitude
  
  // Fire detection data
  brightness            Float    // Fire brightness temperature (K)
  scan                  Float    // Scan size
  track                 Float    // Track size
  brightT31             Float    // Brightness temperature (31um)
  frp                   Float    // Fire Radiative Power (MW)
  
  // Temporal information
  acqDate               DateTime @db.Date // Acquisition date
  acqTime               String   // Acquisition time
  daynight              String   // Day or night detection
  
  // Satellite information
  satellite             String   // Satellite name (MODIS_Terra, VIIRS_Suomi, etc.)
  confidence            String   // Confidence level (nominal, low, high)
  version               String   // Data version
  
  // Alert information
  alertLevel            Int?     // Alert level: 1=Watch, 2=Warning, 3=Emergency
  alertSent             Boolean  @default(false) // Whether alert was sent
  
  // Metadata
  source                String   @default("NASA-FIRMS")
  createdAt             DateTime @default(now())
  
  // Unique constraint to prevent duplicate detections
  @@unique([latitude, longitude, acqDate, acqTime, satellite])
  
  // Indexes for efficient queries
  @@index([latitude, longitude])
  @@index([acqDate])
  @@index([satellite])
  @@index([confidence])
  @@index([frp]) // For filtering by fire intensity
  @@index([alertLevel]) // For filtering by alert level
  @@index([alertSent]) // For tracking sent alerts
  
  @@map("fire_detections")
}